name: "On pull request"

on:
  pull_request:
    types:
      - opened
      - reopened
      - edited
      - synchronize

jobs:
  artifact-vhs:
    name: "Create VHS artifact"
    runs-on: ubuntu-latest
    permissions:
        contents: write
    steps:

      - name: Check out code
        uses: actions/checkout@v4
        with:
            ref: ${{ github.event.pull_request.head.ref }}

      - name: Set up Go 1.x
        uses: actions/setup-go@v4
        with:
          go-version-file: "./go.mod"
  
      - name: Get dependencies
        run: go mod download

      - name: Install binary
        run: |
          APP_VERSION=$(git rev-list -1 HEAD)
          go build -ldflags="-w -s -X 'main.VERSION=$APP_VERSION'" -o "./commit-check" ./exec/cli/main.go
          mv ./commit-check /usr/local/bin/commit-check

      - name: Setup demo repository
        run: |
          mkdir ../demo
          cd ../demo
          git init
          git config user.name "vhs-action"
          git config user.email "actions@github.com"
          touch demo.txt
          git add demo.txt
          echo -e "Type \"cd ../demo\"\n$(cat docs/basic.tape) > docs/basic.tape"

      - uses: charmbracelet/vhs-action@v1
        with:
          path: "docs/basic.tape"

      - name: Commit back changes
        run: |
          mv basic.gif docs/examples/basic.gif
          git add docs/examples/basic.gif
          git config --global user.name "vhs-action"
          git config --global user.email "actions@github.com"
          git commit -m "Updated vhs [skip ci]" || true
          git push
